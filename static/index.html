<!doctype html>
<html>
<head>
<style>

h1{
	height:10%;
}

.section {
	width:100%;
	height:40%;
}

div#memory {
	width:50%;
	height:100%;
	float:left;
}
div#load_avg {
	width:50%;
	height:100%;
	float:left;
}

div#cpu {
	width:50%;
	float:left;
}

div#response {
	width:50%;
	display:block;
	float:left;
}
#response span#response_time {
	font-size: 20px;
}

</style>
</head>

<body>
	<h1 id="hostname"> </h1>
	<div id="main">
		<div class="section">
			<div id="memory"></div>
			<div id="load_avg"></div>
		</div>
		<div class="seciton">
			<div id="cpu"></div>
			<div id="response">
				<b>Last Response Time:</b> <span id="response_time"> -- </span>
			</div>
	</div>
</body>

<script src="/jquery-1.7.1.min.js"></script>
<script src="/highcharts.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
	Highcharts.theme = { colors: ['#4572A7'] };
</script>
<script>

var memory_chart;
var load_avg_chart;
var cpu_chart;
$(document).ready(function() {
cpu_chart = new Highcharts.Chart({
      chart: {
         renderTo: 'cpu',
         defaultSeriesType: 'column'
      },
      title: {
         text: 'CPU Utilization'
      },
      xAxis: {
         categories: ['CPU 1', 'CPU 2', 'CPU 3', 'CPU 4', 'CPU 5']
      },
      yAxis: {
         min: 0,
         title: {
            text: 'Utilization'
         },
         stackLabels: {
            enabled: true,
            style: {
               fontWeight: 'bold',
               color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
         }
      },
      legend: {
         align: 'right',
         x: -100,
         verticalAlign: 'top',
         y: 20,
         floating: true,
         backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColorSolid) || 'white',
         borderColor: '#CCC',
         borderWidth: 1,
         shadow: false
      },
      tooltip: {
         formatter: function() {
            return '<b>'+ this.x +'</b><br/>'+
                this.series.name +': '+ this.y +'<br/>'+
                'Total: '+ this.point.stackTotal;
         }
      },
      plotOptions: {
         column: {
            stacking: 'normal',
            dataLabels: {
               enabled: true,
               color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
            }
         }
      },
       series: [{
         name: 'User',
         data: [5, 3, 4, 7, 2]
      }, {
         name: 'System',
         data: [2, 2, 3, 2, 1]
      }, {
         name: 'Idle',
         data: [3, 4, 4, 2, 5]
      }]
   });

load_avg_chart = new Highcharts.Chart({
      chart: {
         renderTo: 'load_avg',
         defaultSeriesType: 'spline',
         marginRight: 130,
         marginBottom: 25
      },
      title: {
         text: 'Load Average'
      },
		xAxis: {
			type: 'linear',
			tickPixelInterval:70
		},
		yAxis: {
			min: 0.2,
			max: 1.2,
			plotLines: [{
				value: 0,
				width: 1
			}]
		},
      tooltip: {
         formatter: function() {
                   return '<b>'+ this.series.name +'</b><br/>'+
               this.x +': '+ this.y;
         }
      },
      legend: {
         enabled:false
      },
      series: [{
         name: '5 minute load avg',
         data: [{x:0,y:0.0},{x:0,y:0.0},{x:0,y:0.0},{x:0,y:0.0},{x:0,y:0.0},{x:0,y:0.0}]
      }]
   });
   
	memory_chart = new Highcharts.Chart({
		chart: {
			renderTo: 'memory',
			plotBackgroundColor: null,
			plotBorderWidth: null,
			plotShadow: false
		},
		title: {
			text: 'Current Server Memory'
		},
		tooltip: {
			formatter: function() {
				return '<b>'+ this.point.name +'</b>: '+ this.percentage +' %';
			}
		},
		plotOptions: {
			pie: {
				allowPointSelect: true,
				cursor: 'pointer',
				dataLabels: {
					enabled: true,
					color: Highcharts.theme.textColor || '#000000',
					connectorColor: Highcharts.theme.textColor || '#000000',
					formatter: function() {
						return '<b>'+ this.point.name +'</b>: '+ this.percentage +' %';
					}
				}
			}
		},
		series: [{
			type: 'pie',
			name: 'Memory',
			data: [
				['Total Memory',100.0]
			]
		}]
	});
}); 	
</script>

<script>
function update_memory_chart(data) {
	  var gb = data.totalmem/1024/1024/1024;
	  memory_chart.setTitle({text:gb+"GB Memory"});
	  var mem_series = memory_chart.series[0];
	  var free = Math.round(100*(data.freemem/data.totalmem));
	  var used = Math.round(100 - free);
	  mem_data = [
			["Free Memory",free],
			["Used Memory",used]
	  ];
	  mem_series.setData(mem_data);
}

function update_load_chart(data) {
	  var series = load_avg_chart.series[0];
	  series.addPoint({x:points,y:data.loadavg[1]},true,true);
}

function update_cpu_chart(data) {
	var cpu = data.cpu;
}
</script>
<script>
	var socket = io.connect('http://localhost');
	var points = 0;
   socket.on('REQUEST', function (data) {
		  console.log(data);
	     //socket.emit('my other event', { my: 'data' });
		  var t = data.response_time;
		  var color;
		  if(t < 200) {
		 		color = 'green'; 
		  } else if(t>=200 && t<=500) {
		 		color = 'yellow'; 
		  } else {
		 		color = 'red'; 
		  }

		  $('#response_time').html(data.response_time+' ms').css({color:color});
   });

  socket.on('SYSTEM_INFO', function (data) {
		  console.log(data);
		  points++;
		  console.log(points);
		  var hostname = data.hostname;
		  $('#hostname').html(hostname);
		  update_memory_chart(data);
		  update_load_chart(data);
		  update_cpu_chart(data);
   });

</script>

</html>

